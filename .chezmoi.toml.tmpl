# chezmoi configuration template
# Interactive setup on first init - prompts appear only once

# Prompt for user information
{{- $email := promptStringOnce . "email" "Email address" (or (env "EMAIL") (output "git" "config" "user.email" | trim)) -}}
{{- $githubUser := promptStringOnce . "github_user" "GitHub username" "" -}}

# 1Password configuration
{{- $vaultName := promptStringOnce . "onepassword.vault" "1Password vault name" "Personal" -}}
{{- $useGithubToken := promptBoolOnce . "use_github_token" "Fetch GitHub token from 1Password" false -}}
{{- $githubTokenItem := promptStringOnce . "github_token_item" "1Password item name for GitHub token" "GitHub Classic PAT" -}}

# Age encryption (optional)
{{- $useAge := promptBoolOnce . "use_age_encryption" "Enable age encryption for sensitive files" false -}}
{{- $ageRecipient := "" -}}
{{- if $useAge -}}
{{-   $ageRecipient = promptStringOnce . "age.recipient" "Your age public key (run: chezmoi age-keygen)" "" -}}
{{- end -}}

# Zsh configuration
{{- $zshVariant := promptChoice "Zsh config style" (list "monolithic" "modular") "monolithic" -}}
{{- $multiplexer := promptChoice "Terminal multiplexer" (list "tmux" "zellij") "tmux" -}}

# Optional features
{{- $useDifftastic := promptBoolOnce . "use_difftastic" "Enable difftastic git diff integration" true -}}

# Age encryption configuration (must be at top level, before [data])
{{- if and $useAge (ne $ageRecipient "") }}
encryption = "age"

[age]
    identity = "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"
    recipient = {{ $ageRecipient | quote }}
{{- end }}

[data]
    name = "{{ output "git" "config" "user.name" | trim }}"
    email = {{ $email | quote }}
    github_user = {{ $githubUser | quote }}
    github_token = "{{ if $useGithubToken }}{{ or (env "GITHUB_TOKEN") (onepasswordRead (printf "op://%s/%s/credential" $vaultName $githubTokenItem)) "" }}{{ else }}{{ env "GITHUB_TOKEN" }}{{ end }}"

[data.zsh]
    variant = {{ $zshVariant | quote }}
    multiplexer = {{ $multiplexer | quote }}

[data.difftastic]
    enabled = {{ $useDifftastic }}

[data.onepassword]
    vault = {{ $vaultName | quote }}
    github_token_item = {{ $githubTokenItem | quote }}

[onepassword]
    mode = "account"

[edit]
    command = "nvim"
    apply = true

[add]
    secrets = "error"

[git]
    autoCommit = true
    autoPush = true

[merge]
    command = "nvim"
    args = ["-d", "{{ "{{ .Destination }}" }}", "{{ "{{ .Source }}" }}"]
