#!/bin/bash
{{- if eq .chezmoi.os "darwin" }}
# ==============================================================================
# macOS System Preferences Configuration
# ==============================================================================
# This script applies macOS system preferences using the `defaults` command.
# It runs whenever this file is modified (run_onchange_before_).
#
# Dependencies: macOS only
# Execution: Before dotfiles are applied
# Trigger: File content change
#
# References:
# - ADR-0009: macOS defaults automation strategy
# - https://github.com/mathiasbynens/dotfiles
#
# Version Compatibility:
# - These settings work across macOS 12 (Monterey) through current versions
# - Individual commands may fail gracefully on older/newer macOS versions
# - The script continues even if some settings are not supported
# ==============================================================================

# Error handling: Use -u and -o pipefail, but NOT -e
# This allows individual defaults commands to fail without stopping the script
# Some settings may not exist or work on all macOS versions
set -uo pipefail

echo "🔧 Configuring macOS system preferences..."
echo "   (Some settings may be skipped if not supported on this macOS version)"
echo ""

# ==============================================================================
# Dock
# ==============================================================================
echo "📦 Configuring Dock..."

# Auto-hide the Dock
defaults write com.apple.dock autohide -bool true || true

# Set Dock icon size
defaults write com.apple.dock tilesize -int 48 || true

# Don't show recent applications in Dock
defaults write com.apple.dock show-recents -bool false || true

# Minimize windows into their application's icon
defaults write com.apple.dock minimize-to-application -bool true || true

# Show indicator lights for open applications
defaults write com.apple.dock show-process-indicators -bool true || true

# ==============================================================================
# Finder
# ==============================================================================
echo "📁 Configuring Finder..."

# Show path bar in Finder
defaults write com.apple.finder ShowPathbar -bool true || true

# Show status bar in Finder
defaults write com.apple.finder ShowStatusBar -bool true || true

# Show all filename extensions
defaults write NSGlobalDomain AppleShowAllExtensions -bool true || true

# Use list view in all Finder windows by default
# Four-letter codes: `icnv` (icon), `clmv` (column), `glyv` (gallery), `Nlsv` (list)
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv" || true

# When performing a search, search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf" || true

# Disable the warning when changing a file extension
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false || true

# Show hidden files by default
# defaults write com.apple.finder AppleShowAllFiles -bool true

# ==============================================================================
# Screenshots
# ==============================================================================
echo "📸 Configuring Screenshots..."

# Save screenshots to Pictures/Screenshots
defaults write com.apple.screencapture location -string "{{ .chezmoi.homeDir }}/Pictures/Screenshots" || true

# Save screenshots in PNG format (other options: BMP, GIF, JPG, PDF, TIFF)
defaults write com.apple.screencapture type -string "png" || true

# Disable shadow in screenshots
defaults write com.apple.screencapture disable-shadow -bool false || true

# ==============================================================================
# Keyboard & Input
# ==============================================================================
echo "⌨️  Configuring Keyboard & Input..."

# Set a blazingly fast keyboard repeat rate
defaults write NSGlobalDomain KeyRepeat -int 1 || true

# Set a shorter delay until key repeat
defaults write NSGlobalDomain InitialKeyRepeat -int 15 || true

# Disable automatic capitalization
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false || true

# Disable smart dashes
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false || true

# Disable automatic period substitution
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false || true

# Disable smart quotes
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false || true

# Disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false || true

# ==============================================================================
# Trackpad
# ==============================================================================
echo "🖱️  Configuring Trackpad..."

# Enable tap to click for this user and for the login screen
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true || true
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1 || true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1 || true

# ==============================================================================
# Mission Control
# ==============================================================================
echo "🚀 Configuring Mission Control..."

# Don't automatically rearrange Spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false || true

# ==============================================================================
# Energy & Screen
# ==============================================================================
echo "🔋 Configuring Energy & Screen..."

# Require password immediately after sleep or screen saver begins
defaults write com.apple.screensaver askForPassword -int 1 || true
defaults write com.apple.screensaver askForPasswordDelay -int 0 || true

# ==============================================================================
# Other
# ==============================================================================
echo "⚙️  Configuring Other Settings..."

# Expand save panel by default
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true || true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true || true

# Expand print panel by default
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true || true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true || true

# Disable the "Are you sure you want to open this application?" dialog
# Note: This is a security setting that may not work on all macOS versions
defaults write com.apple.LaunchServices LSQuarantine -bool false || true

# Disable Resume system-wide
defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool false || true

# ==============================================================================
# Restart Affected Applications
# ==============================================================================
echo "🔄 Restarting affected applications..."

for app in \
    "Dock" \
    "Finder" \
    "SystemUIServer"; do
    killall "${app}" &>/dev/null || true
done

echo "✅ macOS system preferences configured successfully"
echo ""
echo "📝 Notes:"
echo "   - Some changes may require a logout/restart to take full effect"
echo "   - Hidden files setting is commented out by default"
echo "   - To discover your current settings, run: mise run sys-discover-settings"

{{- end }}
