# =============================================================================
# Mise Configuration - Development Tools & Environment Management
# =============================================================================
# Docs: https://mise.jdx.dev/

[tools]
# Language runtimes
node = "lts"                                        # Node.js LTS version
python = "3.13"                                     # Python 3.13 (stable)
go = "latest"                                       # Latest Go version
ruby = "3.3"                                        # Ruby 3.3
java = "temurin-11"                                 # Java 11 (Temurin LTS, supported until 2029)
rust = "stable"                                     # Rust stable (managed by mise instead of rustup)

# npm global packages
"npm:@anthropic-ai/claude-code" = "latest"          # Claude Code CLI
"npm:@google/gemini-cli" = "latest"                 # Gemini CLI
"npm:@openai/codex" = "latest"                      # OpenAI Codex CLI
"npm:@github/copilot" = "latest"                    # GitHub Copilot CLI (2025 official version)
"npm:@slidev/cli" = "latest"                        # Slidev presentation tool
"npm:git-open" = "latest"                           # Open GitHub repo from terminal
"npm:ccusage" = "latest"                            # Claude Code usage tracker
"npm:pm2" = "latest"                                # Production process manager for Node.js

# Python tools (pipx/uvx)
"pipx:claude-monitor" = "latest"                    # Claude Code usage monitor

# Infrastructure
terraform = "latest"                                # HashiCorp Terraform
terraform-docs = "latest"                           # Terraform documentation generator

# Secrets Management
fnox = "latest"                                     # Modern secret manager (age, 1Password, cloud providers)
aws-vault = "latest"                                # Secure AWS credentials vault (ByteNess fork)
awscli = "latest"                                   # AWS Command Line Interface v2

# Modern shell (experimental)
"cargo:nu" = "latest"                               # Nushell - modern shell with structured data

# Git hooks and security
# Note: lefthook, gitleaks, pre-commit moved to Brewfile for better compatibility
#       Homebrew bottles are faster than Go compilation, and PATH is already set
#       See: dot_Brewfile.tmpl

# Terminal multiplexer tools
"go:github.com/dphaener/zellijinator" = "latest"    # Zellij session manager (tmuxp/tmuxinator alternative)

# =============================================================================
# LSP Servers - Language Server Protocol for all development languages
# =============================================================================

# --- TypeScript/JavaScript ---
"npm:typescript-language-server" = "latest"         # TypeScript/JavaScript LSP
"npm:typescript" = "latest"                         # TypeScript compiler (required by ts-language-server)

# --- Python ---
"npm:pyright" = "latest"                            # Python LSP (fast, type-aware)

# --- Go ---
"go:golang.org/x/tools/gopls" = "latest"            # Official Go LSP

# --- Rust ---
# Note: rust-analyzer is installed via rustup (not mise)
# Install: rustup component add rust-analyzer
# Reason: rust-analyzer is a rustup component, not a cargo installable binary

# --- C/C++ ---
"ubi:clangd/clangd" = "latest"                      # C/C++ LSP (from GitHub releases)

# --- HTML/CSS/JSON/ESLint ---
"npm:vscode-langservers-extracted" = "latest"       # HTML, CSS, JSON, ESLint LSP servers

# =============================================================================
# Code Formatters & Linters
# =============================================================================

"npm:prettier" = "latest"                           # Multi-language formatter
"npm:@fsouza/prettierd" = "latest"                  # Faster prettier daemon
"cargo:stylua" = "latest"                           # Lua formatter
# Note: shfmt moved to Brewfile for better compatibility (bottled, no Go compilation)
"pipx:ruff" = "latest"                              # Fast Python linter/formatter
"pipx:black" = "latest"                             # Python code formatter

[settings]
experimental = true

# =============================================================================
# Environment Variables
# =============================================================================
# Shared environment variables for tasks

[env]
CACHE_DIR = "~/.cache"
DOTFILES_DIR = "~/.local/share/chezmoi"
# Fix GO111MODULE=off error when checking Go tool versions
GO111MODULE = "on"
# Gemini CLI: Enable sandbox mode by default
GEMINI_SANDBOX = "true"

# =============================================================================
# Task Runner - Development Workflow Automation
# =============================================================================
# Run: mise <task> or mise run <task>
# List: mise tasks
#
# Naming Convention:
#   [category]-[action]  (e.g., sys-update, dot-apply)
#
# Categories:
#   sys-  : System maintenance (update, clean, check)
#   dot-  : Dotfiles management (apply, backup, diff)
#   tool- : Tool management (install, outdated)

# --- System Maintenance ---

[tasks.sys-update]
description = "[sys] Update all tools and prune old versions"
alias = "up"
run = ["mise upgrade", "mise prune -y"]

[tasks.sys-clean]
description = "[sys] Clean all caches (sheldon, zsh, mise)"
alias = "c"
run = [
  "rm -rf $CACHE_DIR/sheldon",
  "rm -rf ~/.zcompdump*",
  "mise cache clear"
]

[tasks.sys-check]
description = "[sys] Verify mise installation and config"
alias = "chk"
run = "mise doctor"

[tasks.sys-health]
description = "[sys] Run comprehensive health checks"
alias = "h"
run = [
  "echo '=== Mise ==='",
  "mise doctor",
  "echo '\n=== Homebrew ==='",
  "brew doctor",
  "echo '\n=== Chezmoi ==='",
  "chezmoi verify",
]

[tasks.sys-status]
description = "[sys] Show system status (tools, caches)"
alias = "st"
run = [
  "echo '=== Installed Tools ==='",
  "mise ls",
  "echo '\n=== Cache Status ==='",
  "du -sh $CACHE_DIR/sheldon 2>/dev/null || echo 'No sheldon cache'",
  "du -sh ~/.zcompdump* 2>/dev/null || echo 'No zsh cache'",
]

[tasks.sys-bench]
description = "[sys] Benchmark zsh startup time (10x)"
alias = "b"
run = "bash -c 'for i in {1..10}; do /usr/bin/time -p zsh -i -c exit 2>&1 | /usr/bin/grep real; done'"

{{- if eq .chezmoi.os "darwin" }}

[tasks.sys-discover-settings]
description = "[sys] Extract current macOS defaults settings"
alias = "discover"
run = '''
#!/bin/bash
set -eufo pipefail
echo "üìù Extracting current macOS system preferences..."
cd "${HOME}/.local/share/chezmoi"
./scripts/extract-macos-defaults.sh
echo ""
echo "üí° Review the generated file and copy desired settings to:"
echo "   run_onchange_before_configure-macos.sh.tmpl"
'''

[tasks.sys-apply-settings]
description = "[sys] Apply macOS defaults settings"
alias = "apply-settings"
run = '''
#!/bin/bash
set -eufo pipefail
echo "üîß Applying macOS system preferences..."
chezmoi apply --include=scripts
echo "‚úÖ Settings applied. Some changes may require logout/restart."
'''
{{- end }}

# --- Dotfiles Management ---

[tasks.dot-apply]
description = "[dot] Apply dotfiles to system"
alias = "a"
run = "chezmoi apply"

[tasks.dot-backup]
description = "[dot] Push dotfiles to remote repo"
alias = "bak"
run = "chezmoi git -- push"

[tasks.dot-status]
description = "[dot] Show git status of dotfiles"
alias = "s"
run = "chezmoi git -- status"

[tasks.dot-diff]
description = "[dot] Show diff between source and applied"
alias = "d"
run = "chezmoi diff"

# --- Tool Management ---

[tasks.tool-install]
description = "[tool] Install all tools from config"
alias = "i"
run = "mise install"

[tasks.tool-outdated]
description = "[tool] Check for outdated tools"
alias = "out"
run = "mise outdated"

# --- 1Password & Secrets Management ---
# Note: Use 'ops' shell function to sign in (defined in zsh functions)

[tasks.op-status]
description = "[1pass] Check 1Password authentication status"
alias = "opst"
run = "op whoami || echo 'Not signed in. Run: ops'"

[tasks.op-vaults]
description = "[1pass] List all vaults"
alias = "opv"
run = "op vault list"

[tasks.op-items]
description = "[1pass] List items in vault"
alias = "opi"
run = "op item list --vault {{ .onepassword.vault }}"

[tasks.op-get]
description = "[1pass] Get item details (usage: mise op-get <item-name>)"
alias = "opg"
run = "op item get \"$1\" --vault {{ .onepassword.vault }}"

[tasks.secrets-age-key-backup]
description = "[secrets] Backup age key to 1Password"
alias = "sbk"
run = """
echo "Backing up age key to 1Password..."
op whoami > /dev/null || { echo "‚ùå Not signed in. Run: ops"; exit 1; }

if [ ! -f ~/.config/chezmoi/key.txt ]; then
  echo "‚ùå Age key not found at ~/.config/chezmoi/key.txt"
  exit 1
fi

# Check if item already exists
if op item get "chezmoi-age-key" --vault {{ .onepassword.vault }} > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  'chezmoi-age-key' already exists in 1Password"
  echo "   Delete it first with: op item delete 'chezmoi-age-key' --vault {{ .onepassword.vault }}"
  exit 1
fi

# Create secure note with age key
op item create --category="Secure Note" \
  --title="chezmoi-age-key" \
  --vault={{ .onepassword.vault }} \
  notesPlain="$(cat ~/.config/chezmoi/key.txt)"

echo "‚úÖ Age key backed up to 1Password as 'chezmoi-age-key'"
echo "   Vault: {{ .onepassword.vault }}"
echo ""
echo "To restore on a new machine:"
echo "  op item get 'chezmoi-age-key' --fields notesPlain --vault {{ .onepassword.vault }} > ~/.config/chezmoi/key.txt"
echo "  chmod 600 ~/.config/chezmoi/key.txt"
"""

[tasks.secrets-age-key-restore]
description = "[secrets] Restore age key from 1Password"
alias = "srk"
run = """
echo "Restoring age key from 1Password..."
op whoami > /dev/null || { echo "‚ùå Not signed in. Run: ops"; exit 1; }

if [ -f ~/.config/chezmoi/key.txt ]; then
  echo "‚ö†Ô∏è  Age key already exists at ~/.config/chezmoi/key.txt"
  echo "   Backup: cp ~/.config/chezmoi/key.txt ~/.config/chezmoi/key.txt.backup"
  read -p "   Overwrite existing key? (y/N): " confirm
  if [ "$confirm" != "y" ]; then
    echo "‚ùå Cancelled"
    exit 1
  fi
fi

mkdir -p ~/.config/chezmoi

# Restore from 1Password
op item get "chezmoi-age-key" --fields notesPlain --vault {{ .onepassword.vault }} > ~/.config/chezmoi/key.txt
chmod 600 ~/.config/chezmoi/key.txt

echo "‚úÖ Age key restored from 1Password"
echo "   Location: ~/.config/chezmoi/key.txt"
echo "   Permissions: 600"
echo ""
echo "Verify with: mise secrets-verify"
"""

[tasks.secrets-test]
description = "[secrets] Test template with onepasswordRead"
alias = "sct"
run = """
echo "Testing 1Password template integration..."
op whoami > /dev/null || { echo "‚ùå Not signed in. Run: ops"; exit 1; }
echo "‚úÖ 1Password authenticated"
echo "\nVaults available:"
op vault list
echo "\nTest reading a secret (replace with your actual op:// path):"
echo 'Example: chezmoi execute-template '"'"'{% raw %}{{ "{{" }} onepasswordRead "op://Personal/API/password" {{ "}}" }}{% endraw %}'"'"
"""

[tasks.secrets-list]
description = "[secrets] List age-encrypted files in chezmoi"
alias = "sl"
run = "chezmoi managed | grep -E '\\.age$|encrypted' || echo 'No encrypted files found'"

[tasks.secrets-add]
description = "[secrets] Add file with age encryption (usage: mise secrets-add <file>)"
alias = "sa"
run = "chezmoi add --encrypt \"$1\""

[tasks.secrets-verify]
description = "[secrets] Verify age encryption setup"
alias = "sv"
run = """
echo "=== Age Key Status ==="
if [ -f ~/.config/chezmoi/key.txt ]; then
  echo "‚úÖ Age key exists: ~/.config/chezmoi/key.txt"
  echo "Public key: $(grep -A1 'public key:' ~/.config/chezmoi/key.txt 2>/dev/null || echo 'age14t9x0zwv2adeujgjryk33s4f7wcxmsn7y7ws65hz7fs80fw9rfeqk8a4rg')"
else
  echo "‚ùå Age key not found. Generate with: chezmoi age-keygen --output=~/.config/chezmoi/key.txt"
fi

echo "\n=== 1Password Status ==="
op whoami > /dev/null 2>&1 && echo "‚úÖ Signed in to 1Password" || echo "‚ùå Not signed in. Run: mise op-signin"

echo "\n=== Chezmoi Encryption Config ==="
grep -A3 'encryption = "age"' ~/.config/chezmoi/chezmoi.toml || echo "‚ùå Age encryption not configured in chezmoi"
"""

# --- fnox (Modern Secret Manager) ---

[tasks.fnox-init]
description = "[fnox] Initialize fnox configuration"
alias = "fxi"
run = """
echo "üîê Initializing fnox..."
if ! command -v fnox &> /dev/null; then
  echo "‚ùå fnox not installed. Installing via mise..."
  mise use -g fnox
  echo "‚úÖ fnox installed"
fi
mkdir -p ~/.config/fnox/secrets
chmod 700 ~/.config/fnox/secrets
if [ -f ~/.config/fnox/fnox.toml ]; then
  echo "‚úÖ fnox configuration found"
else
  echo "‚ùå fnox configuration not found. Run 'chezmoi apply'"
  exit 1
fi
echo "‚úÖ fnox initialized successfully"
"""

[tasks.fnox-add]
description = "[fnox] Add a new secret (usage: mise fnox-add <name> <value>)"
alias = "fxa"
run = """
if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: mise fnox-add <name> <value>"
  exit 1
fi
fnox set "$1" "$2"
"""

[tasks.fnox-get]
description = "[fnox] Get a secret value (usage: mise fnox-get <name>)"
alias = "fxg"
run = "fnox get \"$1\""

[tasks.fnox-list]
description = "[fnox] List all secrets"
alias = "fxl"
run = "fnox list"

[tasks.fnox-status]
description = "[fnox] Show fnox status and backend health"
alias = "fxs"
run = """
echo "=== fnox Status ==="
if command -v fnox &> /dev/null; then
  echo "‚úÖ fnox installed: $(which fnox)"
else
  echo "‚ùå fnox not installed. Run: mise use -g fnox"
fi
if [ -f ~/.config/fnox/fnox.toml ]; then
  echo "‚úÖ Config found: ~/.config/fnox/fnox.toml"
fi
fnox backends 2>/dev/null || true
"""

# --- AI Profile Management (Claude Code / API Switching) ---

[tasks.claude-switch]
description = "[claude] Switch between API and MAX authentication"
alias = "cls"
usage = '''
arg "<profile>" help="API (pay-per-use) or MAX (subscription)" {
  choices "API" "MAX" "api" "max"
}
'''
run = '''
set -eu
CFG=~/.config/claude
profile="${usage_profile}"

mkdir -p "$CFG"

case "$profile" in
  API|api)
    # Check API config exists
    if [ ! -f "$CFG/.env.api" ]; then
      echo "‚ùå $CFG/.env.api not found."
      echo "   Run: mise claude-init"
      exit 1
    fi

    # Switch to API profile
    cp "$CFG/.env.api" "$CFG/.env"

    echo ""
    echo "‚úÖ Switched to API mode"
    echo "   üí≥ Usage will be charged to API key"
    echo ""
    echo "üí° ANTHROPIC_API_KEY takes precedence over any logged-in account"
    echo ""
    echo "‚ö†Ô∏è  Apply changes:"
    echo "   Option 1: Open NEW terminal tab"
    echo "   Option 2: Run in current shell:"
    echo "             source ~/.config/claude/.env"
    echo ""
    echo "   Then verify with: claude"
    echo "                    (run /status to confirm)"
    ;;

  MAX|max)
    # Check MAX config exists
    if [ ! -f "$CFG/.env.max" ]; then
      echo "‚ùå $CFG/.env.max not found."
      echo "   Run: chezmoi apply"
      exit 1
    fi

    # Switch to MAX profile (unsets ANTHROPIC_API_KEY)
    cp "$CFG/.env.max" "$CFG/.env"

    echo ""
    echo "‚úÖ Switched to MAX mode"
    echo "   üé´ Usage will be charged to Max/Pro subscription"
    echo ""
    echo "‚ö†Ô∏è  Apply changes:"
    echo "   Option 1: Open NEW terminal tab"
    echo "   Option 2: Run in current shell:"
    echo "             unset ANTHROPIC_API_KEY"
    echo "             source ~/.config/claude/.env"
    echo ""
    echo "   Then run: claude"
    echo "   (Login prompt will appear if not already logged in)"
    ;;

  *)
    echo "Usage: mise claude-switch [API|MAX]" >&2
    exit 1
    ;;
esac
'''

[tasks.claude-current]
description = "[claude] Show current AI profile"
alias = "clc"
run = '''
CFG=~/.config/claude
if [ ! -f "$CFG/.env" ]; then
  echo "‚ùå No AI profile active"
  echo "   Run: mise ai-use [API|MAX]"
  exit 0
fi

echo "=== Current AI Profile ==="
grep -E "^(AI_PROFILE|ANTHROPIC_API_KEY)=" "$CFG/.env" | while IFS='=' read -r key value; do
  case "$key" in
    AI_PROFILE)
      echo "Profile: $value"
      ;;
    ANTHROPIC_API_KEY)
      if [ -n "$value" ] && [ "$value" != "" ]; then
        len=$(printf "%s" "$value" | wc -c | tr -d ' ')
        echo "API Key: ${value:0:8}...${value: -4} ($len chars)"
      else
        echo "API Key: (not set)"
      fi
      ;;
  esac
done
'''

[tasks.ai-exec]
description = "[claude] Execute command with current AI profile"
alias = "aie"
run = '''
set -a
[ -f ~/.config/claude/.env ] && . ~/.config/claude/.env
set +a
exec "$@"
'''

[tasks.claude-init]
description = "[claude] Initialize AI profile configuration"
alias = "cli"
run = '''
set -eu
echo "üîß Initializing AI profile configuration..."
CFG=~/.config/claude
mkdir -p "$CFG"

# Apply chezmoi templates first (creates .env.max and .env.api.example)
echo "üì¶ Applying chezmoi templates..."
chezmoi apply --include="$HOME/.config/claude/*" 2>/dev/null || true

# Try to fetch API key from 1Password
if [ ! -f "$CFG/.env.api" ]; then
  echo ""
  echo "üîê Attempting to fetch API key from 1Password..."

  if ! command -v op &> /dev/null; then
    echo "‚ö†Ô∏è  1Password CLI (op) not found"
    echo "   Install: brew install 1password-cli"
    echo ""
    echo "üìù Manual setup required:"
    echo "   cp $CFG/.env.api.example $CFG/.env.api"
    echo "   Edit $CFG/.env.api and add your API key"
  elif ! op whoami &> /dev/null; then
    echo "‚ö†Ô∏è  Not signed in to 1Password"
    echo "   Sign in: eval \$(op signin)"
    echo ""
    echo "üìù Manual setup required:"
    echo "   cp $CFG/.env.api.example $CFG/.env.api"
    echo "   Edit $CFG/.env.api and add your API key"
  else
    # Try to read from 1Password
    VAULT="{{ .onepassword.vault }}"
    ITEM="Claude Code API Key"

    if API_KEY=$(op read "op://$VAULT/$ITEM/credential" 2>/dev/null); then
      cat > "$CFG/.env.api" <<EOF
# =============================================================================
# AI Profile: API Mode
# =============================================================================
# Auto-generated from 1Password on $(date)

# Anthropic API Key
ANTHROPIC_API_KEY=$API_KEY

# Profile identifier
AI_PROFILE=API

# Config directory (using default)
CLAUDE_CONFIG_DIR=$HOME/.claude

# Optional: OpenAI-compatible router (e.g., LiteLLM)
# Uncomment if using a proxy/router
# OPENAI_BASE_URL=http://localhost:4000
# OPENAI_API_KEY=proxy-key
EOF
      chmod 600 "$CFG/.env.api"
      echo "‚úÖ API key fetched from 1Password"
    else
      echo "‚ö†Ô∏è  Failed to read from 1Password"
      echo "   Item: $ITEM (Vault: $VAULT)"
      echo ""
      echo "üìù Manual setup required:"
      echo "   cp $CFG/.env.api.example $CFG/.env.api"
      echo "   Edit $CFG/.env.api and add your API key"
    fi
  fi
fi

# Set default profile if none exists
if [ ! -f "$CFG/.env" ]; then
  echo ""
  echo "‚ö†Ô∏è  No active profile. Setting default to MAX..."
  if [ -f "$CFG/.env.max" ]; then
    cp "$CFG/.env.max" "$CFG/.env"
    echo "‚úÖ Default profile set to MAX"
  else
    echo "‚ùå Cannot set default profile: .env.max not found"
    exit 1
  fi
fi

echo ""
echo "‚úÖ AI profile configuration initialized"
mise claude-current
'''

# === Codex Profile Management ===

[tasks.codex-switch]
description = "[codex] Switch between API and subscription auth"
alias = "cxs"
usage = '''
arg "<profile>" help="API (pay-per-use) or subscription (ChatGPT Plus/Pro)" {
  choices "API" "api" "MAX" "max"
}
'''
run = '''
set -eu
CFG=~/.config/codex
profile="${usage_profile}"
mkdir -p "$CFG"

case "$profile" in
  API|api)
    # Check API config exists
    if [ ! -f "$CFG/.env.api" ]; then
      echo "‚ùå $CFG/.env.api not found."
      echo "   Run: mise codex-init"
      exit 1
    fi

    # Switch to API profile
    cp "$CFG/.env.api" "$CFG/.env"

    # Load and login with API key
    set -a
    . "$CFG/.env.api"
    set +a

    echo ""
    echo "‚úÖ Switched to API mode"
    echo "   üí≥ Usage will be charged to API key"
    echo ""

    # Perform login
    if [ -n "${OPENAI_API_KEY:-}" ]; then
      echo "üîê Logging in with API key..."
      if printf "%s" "$OPENAI_API_KEY" | mise exec -- codex login --with-api-key 2>&1; then
        echo "‚úÖ Logged in successfully"
      else
        echo "‚ö†Ô∏è  Login failed"
      fi
    fi

    echo ""
    echo "‚ö†Ô∏è  Apply changes:"
    echo "   Option 1: Open NEW terminal tab"
    echo "   Option 2: Run in current shell:"
    echo "             source ~/.config/codex/.env"
    echo ""
    echo "   Then verify with: mise exec -- codex login status"
    ;;

  MAX|max)
    # Check MAX config exists
    if [ ! -f "$CFG/.env.max" ]; then
      echo "‚ùå $CFG/.env.max not found."
      echo "   Run: chezmoi apply"
      exit 1
    fi

    # Switch to MAX profile (unsets OPENAI_API_KEY)
    cp "$CFG/.env.max" "$CFG/.env"

    echo ""
    echo "‚úÖ Switched to subscription mode"
    echo "   üé´ Usage will be charged to ChatGPT subscription"
    echo ""
    echo "‚ö†Ô∏è  Apply changes:"
    echo "   Option 1: Open NEW terminal tab"
    echo "   Option 2: Run in current shell:"
    echo "             unset OPENAI_API_KEY"
    echo "             source ~/.config/codex/.env"
    echo ""
    echo "   Then run: codex"
    echo "   (Login prompt will appear if not already logged in)"
    ;;

  *)
    echo "Usage: mise codex-switch [API|MAX]" >&2
    exit 1
    ;;
esac
'''

[tasks.codex-current]
description = "[codex] Show current Codex profile"
alias = "cxc"
run = '''
CFG=~/.config/codex
if [ ! -f "$CFG/.env" ]; then
  echo "‚ùå No Codex profile active"
  echo "   Run: mise codex-init"
  exit 1
fi

echo "=== Current Codex Profile ==="
while IFS='=' read -r key value; do
  [[ "$key" =~ ^[[:space:]]*# ]] && continue
  [[ -z "$key" ]] && continue
  key=$(echo "$key" | xargs)
  value=$(echo "$value" | xargs)
  if [ -n "$key" ] && [ -n "$value" ]; then
    len=$(printf "%s" "$value" | wc -c | xargs)
    if [ "$len" -gt 20 ]; then
      echo "$key: ${value:0:20}..."
    else
      echo "$key: $value"
    fi
  fi
done < "$CFG/.env"
'''

[tasks.codex-use]
description = "[codex] Run command with active Codex profile"
alias = "cxu"
run = '''
set -a
[ -f ~/.config/codex/.env ] && . ~/.config/codex/.env
set +a
exec "$@"
'''

[tasks.codex-init]
description = "[codex] Initialize Codex profile configuration"
alias = "cxi"
run = '''
set -eu
echo "üîß Initializing Codex profile configuration..."
CFG=~/.config/codex
mkdir -p "$CFG"

# Apply chezmoi templates first (creates .env.max and .env.api.example)
echo "üì¶ Applying chezmoi templates..."
chezmoi apply --include="$HOME/.config/codex/*" 2>/dev/null || true

# Try to fetch API key from 1Password
if [ ! -f "$CFG/.env.api" ]; then
  echo ""
  echo "üîê Attempting to fetch API key from 1Password..."

  if ! command -v op &> /dev/null; then
    echo "‚ö†Ô∏è  1Password CLI (op) not found"
    echo "   Install: brew install 1password-cli"
    echo ""
    echo "üìù Manual setup required:"
    echo "   cp $CFG/.env.api.example $CFG/.env.api"
    echo "   Edit $CFG/.env.api and add your API key"
  elif ! op whoami &> /dev/null; then
    echo "‚ö†Ô∏è  Not signed in to 1Password"
    echo "   Sign in: eval \$(op signin)"
    echo ""
    echo "üìù Manual setup required:"
    echo "   cp $CFG/.env.api.example $CFG/.env.api"
    echo "   Edit $CFG/.env.api and add your API key"
  else
    # Try to read from 1Password
    VAULT="{{ .onepassword.vault }}"
    ITEM="OpenAI API Key"

    if API_KEY=$(op read "op://$VAULT/$ITEM/credential" 2>/dev/null); then
      cat > "$CFG/.env.api" <<EOF
# =============================================================================
# Codex Profile: API Mode
# =============================================================================
# Auto-generated from 1Password on $(date)

# OpenAI API Key
OPENAI_API_KEY=$API_KEY

# Profile identifier
CODEX_PROFILE=API

# Config directory (keeps work and personal accounts completely separated)
CODEX_HOME=$HOME/.codex-work
EOF
      chmod 600 "$CFG/.env.api"
      echo "‚úÖ API key fetched from 1Password"
    else
      echo "‚ö†Ô∏è  Failed to read from 1Password"
      echo "   Item: $ITEM (Vault: $VAULT)"
      echo ""
      echo "üìù Manual setup required:"
      echo "   cp $CFG/.env.api.example $CFG/.env.api"
      echo "   Edit $CFG/.env.api and add your API key"
    fi
  fi
fi

# Initialize CODEX_HOME directories with config.toml
echo ""
echo "üìÅ Initializing Codex config directories..."

# Work directory (API mode)
WORK_DIR="$HOME/.codex-work"
mkdir -p "$WORK_DIR"
if [ ! -f "$WORK_DIR/config.toml" ]; then
  cat > "$WORK_DIR/config.toml" <<EOF
# Codex configuration for work account (API mode)
# Auto-generated by mise codex-init

# Authentication
preferred_auth_method = "apikey"

# Model settings
model = "gpt-5"
model_provider = "openai"

# Sandbox and approval
sandbox_mode = "workspace-write"
approval_policy = "untrusted"
EOF
  echo "‚úÖ Created $WORK_DIR/config.toml"
else
  echo "‚ö†Ô∏è  $WORK_DIR/config.toml already exists (skipped)"
fi

# Personal directory (subscription mode)
PERSONAL_DIR="$HOME/.codex-personal"
mkdir -p "$PERSONAL_DIR"
if [ ! -f "$PERSONAL_DIR/config.toml" ]; then
  cat > "$PERSONAL_DIR/config.toml" <<EOF
# Codex configuration for personal account (subscription mode)
# Auto-generated by mise codex-init

# Authentication
preferred_auth_method = "chatgpt"

# Model settings
model = "gpt-5"
model_provider = "openai"

# Sandbox and approval
sandbox_mode = "workspace-write"
approval_policy = "untrusted"
EOF
  echo "‚úÖ Created $PERSONAL_DIR/config.toml"
else
  echo "‚ö†Ô∏è  $PERSONAL_DIR/config.toml already exists (skipped)"
fi

# Perform API key login for work account
if [ -f "$CFG/.env.api" ]; then
  echo ""
  echo "üîê Logging in with API key for work account..."

  # Load API profile
  set -a
  . "$CFG/.env.api"
  set +a

  # Login with API key
  if [ -n "${OPENAI_API_KEY:-}" ]; then
    if printf "%s" "$OPENAI_API_KEY" | mise exec -- codex login --with-api-key 2>&1; then
      echo "‚úÖ Logged in to work account (.codex-work) using API key"
    else
      echo "‚ö†Ô∏è  API key login failed. You may need to login manually:"
      echo "   CODEX_HOME=~/.codex-work printenv OPENAI_API_KEY | codex login --with-api-key"
    fi
  else
    echo "‚ö†Ô∏è  OPENAI_API_KEY not set in .env.api"
  fi
fi

# Set default profile if none exists
if [ ! -f "$CFG/.env" ]; then
  echo ""
  echo "‚ö†Ô∏è  No active profile. Setting default to MAX..."
  if [ -f "$CFG/.env.max" ]; then
    cp "$CFG/.env.max" "$CFG/.env"
    echo "‚úÖ Default profile set to MAX (subscription)"
  else
    echo "‚ùå Cannot set default profile: .env.max not found"
    exit 1
  fi
fi

echo ""
echo "‚úÖ Codex profile configuration initialized"
mise codex-current
'''

# --- Workflows (Complex Operations) ---

[tasks.workflow-sync]
description = "[workflow] Full sync: apply ‚Üí update ‚Üí clean"
alias = "sy"
depends = ["dot-apply", "sys-update", "sys-clean"]

[tasks.workflow-fresh]
description = "[workflow] Fresh start: clean ‚Üí apply ‚Üí update"
alias = "f"
run = [
  "mise run sys-clean",
  "mise run dot-apply",
  "mise run sys-update",
]

# --- Benchmark & Performance ---

[tasks.sys-bench-shell]
description = "[sys] Benchmark shell startup times (zsh vs bash)"
alias = "bsh"
run = "hyperfine --warmup 3 'zsh -i -c exit' 'bash -i -c exit'"

[tasks.sys-bench-multi]
description = "[sys] Benchmark multiplexer startup times"
alias = "bm"
run = """
echo "=== Tmux startup ==="
hyperfine --warmup 2 'tmux new-session -d "exit" && tmux kill-server'
echo "\n=== Zellij startup ==="
hyperfine --warmup 2 'zellij --session test-bench && zellij delete-session test-bench -f'
"""

# --- Update & Maintenance ---

[tasks.sys-outdated]
description = "[sys] Check all outdated packages (brew + mise)"
alias = "outd"
run = """
echo "=== Homebrew Outdated ==="
brew outdated
echo "\n=== Mise Outdated ==="
mise outdated
"""

[tasks.sys-upgrade-all]
description = "[sys] Upgrade all packages (brew + mise + cleanup)"
alias = "ua"
run = """
echo "=== Upgrading Homebrew Packages ==="
brew upgrade
brew cleanup
echo "\n=== Upgrading Mise Tools ==="
mise upgrade
mise prune -y
echo "\n=== Checking Dotfiles ==="
chezmoi git -- fetch origin
chezmoi git -- log HEAD..origin/main --oneline || echo "Already up to date"
"""

# --- Backup & Archive ---

[tasks.dot-backup-archive]
description = "[dot] Create timestamped backup archive"
alias = "bka"
run = """
mkdir -p ~/backups
tar czf ~/backups/dotfiles-$(date +%Y%m%d-%H%M%S).tar.gz ~/.local/share/chezmoi
echo "‚úÖ Backup created: ~/backups/dotfiles-$(date +%Y%m%d-%H%M%S).tar.gz"
find ~/backups -name "dotfiles-*.tar.gz" -mtime +30 -exec rm {} \\; -print
echo "‚úÖ Cleaned up backups older than 30 days"
"""

[tasks.dot-backup-list]
description = "[dot] List all backup archives"
alias = "bkl"
run = "ls -lh ~/backups/dotfiles-*.tar.gz 2>/dev/null || echo 'No backups found'"

# --- Diagnostics ---

[tasks.sys-diag]
description = "[sys] Full system diagnostics"
alias = "diag"
run = """
echo "=== System Info ==="
sw_vers
echo "\n=== Shell ==="
echo $SHELL
$SHELL --version
echo "\n=== Mise ==="
mise doctor
echo "\n=== Homebrew ==="
brew doctor
echo "\n=== Chezmoi ==="
chezmoi verify
echo "\n=== Disk Usage ==="
df -h | grep -E '/$|/Users'
echo "\n=== Memory ==="
vm_stat | head -n 10
"""

# --- Workflow Enhancement ---

[tasks.workflow-fresh-install]
description = "[workflow] Fresh install setup (for new machines)"
alias = "fresh"
run = """
echo "=== Running fresh install workflow ==="
mise run sys-clean
mise run tool-install
mise run dot-apply
mise run sys-update
echo "\n=== Setup Complete! ==="
mise run sys-health
"""
