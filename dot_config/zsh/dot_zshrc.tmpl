# ============================================================================
# Zsh Configuration - Conditional Loader
# ============================================================================
# This file conditionally loads either modular or monolithic configuration
# based on the 'zsh.variant' setting in .chezmoi.toml
#
# Supported variants:
#   - "modular" (default): Optimized multi-file configuration with deferred loading
#   - "monolithic": Single-file configuration (legacy, for compatibility)
#
# Switch between variants using: switch-zsh-config
{{- $variant := "modular" -}}
{{- if hasKey . "zsh" -}}
  {{- if .zsh.variant -}}
    {{- $variant = .zsh.variant -}}
  {{- end -}}
{{- end }}
# Current variant: {{ $variant }}
# ============================================================================

{{- if eq $variant "modular" }}
# ============================================================================
# Modular Configuration
# ============================================================================
# Module loading order:
#   01-init.zsh        - Core initialization (Homebrew, Prompt)
#   02-plugins.zsh     - Plugin management (Sheldon, zsh-defer)
#   03-tools.zsh       - Tool configuration (FZF, completions, deferred tools)
#   04-env.zsh         - Environment variables
#   05-aliases.zsh     - All aliases
#   06-functions.zsh   - Utility and shell management functions
#   07-repo.zsh        - Repository management functions
#
# Performance: Modular configuration with deferred loading
#   - Isolated test: 41.1ms vs 48.9ms monolithic (16% faster)
#   - Real environment: 48.7ms min, 55.1ms avg (15% faster than 57ms baseline)
#   - Deferred modules (05, 06, 07, PATH) load asynchronously after prompt
# ============================================================================

# Performance profiling (uncomment when benchmarking)
# zmodload zsh/zprof

# Load configuration modules
# Critical modules first (needed immediately for prompt and interactive shell)
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/01-init.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/02-plugins.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/03-tools.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/04-env.zsh"

# Deferred modules (loaded after prompt is shown - saves ~15-20ms at startup)
# These are only needed for interactive use, not for prompt rendering
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/05-aliases.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/06-functions.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/07-repo.zsh"

# Performance profiling (uncomment when benchmarking)
# zprof | head -40

{{- else if eq $variant "monolithic" }}
# ============================================================================
# Monolithic Configuration (Legacy)
# ============================================================================
{{ includeTemplate "zshrc-monolithic.tmpl" . -}}
{{- else }}
# ============================================================================
# Invalid Configuration Variant
# ============================================================================
echo "Error: Invalid zsh.variant '{{ $variant }}' in .chezmoi.toml"
echo "Supported values: 'modular' or 'monolithic'"
echo "Defaulting to modular configuration..."

# Fallback to modular
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/01-init.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/02-plugins.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/03-tools.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/04-env.zsh"

zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/05-aliases.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/06-functions.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/07-repo.zsh"
{{- end }}
