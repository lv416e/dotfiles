# ============================================================================
# Zsh Configuration - Conditional Loader
# ============================================================================
# This file conditionally loads either modular or monolithic configuration
# based on the 'zsh.variant' setting in .chezmoi.toml
#
# Supported variants:
#   - "modular" (default): Optimized multi-file configuration with deferred loading
#   - "monolithic": Single-file configuration (legacy, for compatibility)
#
# Switch between variants using: switch-zsh-config
{{- $variant := "modular" -}}
{{- if hasKey . "zsh" -}}
  {{- if .zsh.variant -}}
    {{- $variant = .zsh.variant -}}
  {{- end -}}
{{- end }}
# Current variant: {{ $variant }}
# ============================================================================

{{- if eq $variant "modular" }}
# ============================================================================
# Modular Configuration
# ============================================================================
# Module loading order:
#   01-init.zsh        - Core initialization (Homebrew, Prompt)
#   02-plugins.zsh     - Plugin management (Sheldon, zsh-defer)
#   03-tools.zsh       - Tool configuration (FZF, completions, deferred tools)
#   04-env.zsh         - Environment variables
#   05-aliases.zsh     - All aliases
#   06-functions.zsh   - Utility and shell management functions
#   07-repo.zsh        - Repository management functions
#
# Performance: Modular configuration with deferred loading + Advanced Optimizations
#   - Baseline (previous): 61-63ms → Optimized: 50-60ms avg (20-24% faster)
#   - Key optimizations:
#     • P10k SSH bypass (0.02ms vs 12-20ms)
#     • mise shims hardcoded in .zprofile (0ms vs 70ms for login shells)
#     • PATH_HELPER caching (5-15ms savings)
#     • mise check optimization (2-5ms savings)
#     • tmux-work double respawn removed (50% faster left panes)
#     • eza --git removed from defaults (10-100ms runtime savings per ls)
#   - Deferred modules (05, 06, 07) load asynchronously after prompt
# ============================================================================

# Performance profiling (uncomment when benchmarking)
# zmodload zsh/zprof

# Load configuration modules
# Critical modules first (needed immediately for prompt and interactive shell)
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/01-init.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/02-plugins.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/03-tools.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/04-env.zsh"

# Deferred modules (loaded after prompt is shown - saves ~15-20ms at startup)
# These are only needed for interactive use, not for prompt rendering
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/05-aliases.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/06-functions.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/07-repo.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/08-promptq.zsh"

# Performance profiling (uncomment when benchmarking)
# zprof | head -40

{{- else if eq $variant "monolithic" }}
# ============================================================================
# Monolithic Configuration (Legacy)
# ============================================================================
{{ includeTemplate "zshrc-monolithic.tmpl" . -}}
{{- else }}
# ============================================================================
# Invalid Configuration Variant
# ============================================================================
echo "Error: Invalid zsh.variant '{{ $variant }}' in .chezmoi.toml"
echo "Supported values: 'modular' or 'monolithic'"
echo "Defaulting to modular configuration..."

# Fallback to modular
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/01-init.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/02-plugins.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/03-tools.zsh"
source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/04-env.zsh"

zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/05-aliases.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/06-functions.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/07-repo.zsh"
zsh-defer source "${ZDOTDIR:-{{ .chezmoi.homeDir }}/.config/zsh}/conf.d/08-promptq.zsh"
{{- end }}
