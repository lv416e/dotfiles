# ============================================================================
# Core Initialization
# Description: Homebrew setup and prompt theme configuration
# Dependencies: None
# ============================================================================

# --- Homebrew ---
{{- if eq .chezmoi.arch "arm64" }}
export HOMEBREW_PREFIX="/opt/homebrew"
export HOMEBREW_CELLAR="/opt/homebrew/Cellar"
export HOMEBREW_REPOSITORY="/opt/homebrew"
fpath[1,0]="/opt/homebrew/share/zsh/site-functions"

# PATH_HELPER optimization: Cache output to avoid spawning process every time (saves 5-15ms)
# Regenerate cache only if /etc/paths or /etc/paths.d/* change
typeset -g _PATH_HELPER_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/zsh/path_helper.zsh"
if [[ ! -f "$_PATH_HELPER_CACHE" ]] || \
   [[ /etc/paths -nt "$_PATH_HELPER_CACHE" ]] || \
   [[ -d /etc/paths.d && /etc/paths.d -nt "$_PATH_HELPER_CACHE" ]]; then
  mkdir -p "${_PATH_HELPER_CACHE:h}"
  /usr/bin/env PATH_HELPER_ROOT="/opt/homebrew" /usr/libexec/path_helper -s > "$_PATH_HELPER_CACHE" 2>/dev/null
fi
[[ -f "$_PATH_HELPER_CACHE" ]] && source "$_PATH_HELPER_CACHE"

[ -z "${MANPATH-}" ] || export MANPATH=":${MANPATH#:}"
export INFOPATH="/opt/homebrew/share/info:${INFOPATH:-}"
{{- else }}
eval "$(/usr/local/bin/brew shellenv)"
HOMEBREW_PREFIX="/usr/local"
{{- end }}

# --- Prompt ---
export PROMPT_THEME="${PROMPT_THEME:-p10k}"

if [[ "$PROMPT_THEME" == "p10k" ]]; then
  # Bypass P10k SSH detection for local sessions (saves 12-20ms)
  # Sets both P9K_SSH and _P9K_SSH_TTY to trigger early-exit in _p9k_init_ssh
  # The function will still run for new TTYs (e.g., actual SSH sessions)
  # Reference: https://github.com/romkatv/powerlevel10k/pull/2774
  typeset -gix P9K_SSH=0
  typeset -gx _P9K_SSH_TTY=$TTY

  if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
    source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
  fi
fi

if [[ "$PROMPT_THEME" == "starship" ]]; then
  eval "$(starship init zsh)"
  export STARSHIP_CONFIG=~/.config/starship.toml
elif [[ "$PROMPT_THEME" == "p10k" ]]; then
  source ~/powerlevel10k/powerlevel10k.zsh-theme
  [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
fi
