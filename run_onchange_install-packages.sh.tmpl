#!/bin/bash
# =============================================================================
# Homebrew Package Installation
# =============================================================================
# Installs packages defined in Brewfile across all environments (macOS, Linux,
# Codespaces, DevContainer). This script executes whenever the Brewfile changes.
#
# Brewfile hash: {{ include "dot_Brewfile.tmpl" | sha256sum }}
#
# Platform behavior:
#   - macOS: Installs formulae and casks
#   - Linux: Installs formulae only (casks automatically skipped)
# =============================================================================

set -eufo pipefail

# Ensure Homebrew is in PATH
if [ -d "/home/linuxbrew/.linuxbrew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [ -d "/opt/homebrew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Verify Homebrew availability
if ! command -v brew >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Homebrew not found. Package installation skipped."
    echo "   Run the setup script to install Homebrew first."
    exit 0
fi

# Install packages from Brewfile
if [ -f "$HOME/.Brewfile" ]; then
    echo "üì¶ Installing packages from Brewfile..."
    echo "   Platform: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"

    if brew bundle --file="$HOME/.Brewfile" --no-lock; then
        echo "‚úÖ Package installation complete"
    else
        echo "‚ö†Ô∏è  Some packages failed to install"
        echo "   Review errors above and run manually if needed: brew bundle --file=\"$HOME/.Brewfile\""
    fi
else
    echo "‚ö†Ô∏è  Brewfile not found at $HOME/.Brewfile"
    exit 1
fi
