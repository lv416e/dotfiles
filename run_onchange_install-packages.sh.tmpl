#!/bin/bash
# =============================================================================
# Homebrew Package Installation
# =============================================================================
# Installs packages defined in Brewfile across all environments (macOS, Linux,
# Codespaces, DevContainer). This script executes whenever the Brewfile changes.
#
# Execution: run_onchange (runs when Brewfile content changes)
# Depends on: Homebrew (run_once_before_10-install-homebrew.sh)
#
# Brewfile hash: {{ include "dot_Brewfile.tmpl" | sha256sum }}
#
# Platform behavior:
#   - macOS: Installs formulae and casks
#   - Linux: Installs formulae only (casks automatically skipped)
# =============================================================================

set -eufo pipefail

# =============================================================================
# Ensure Homebrew is in PATH
# =============================================================================

{{ if eq .chezmoi.os "darwin" -}}
{{   if eq .chezmoi.arch "arm64" -}}
if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{   else -}}
if [ -x "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{   end -}}
{{ else -}}
if [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{ end -}}

# =============================================================================
# Verify Homebrew Availability
# =============================================================================

if ! command -v brew >/dev/null 2>&1; then
    echo "‚ùå ERROR: Homebrew not found"
    echo ""
    echo "Homebrew should have been installed by run_once_before_10-install-homebrew.sh"
    echo "Please check if that script ran successfully."
    echo ""
    echo "To manually install Homebrew:"
    echo '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    echo ""
    exit 1
fi

echo "‚ÑπÔ∏è  Using Homebrew: $(command -v brew)"
echo "‚ÑπÔ∏è  Version: $(brew --version | head -n1)"

# Install packages from Brewfile
if [ -f "$HOME/.Brewfile" ]; then
    echo "üì¶ Installing packages from Brewfile..."
    echo "   Platform: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"

    if brew bundle --file="$HOME/.Brewfile"; then
        echo "‚úÖ Package installation complete"
    else
        echo "‚ö†Ô∏è  Some packages failed to install"
        echo "   Review errors above and run manually if needed: brew bundle --file=\"$HOME/.Brewfile\""
    fi
else
    echo "‚ö†Ô∏è  Brewfile not found at $HOME/.Brewfile"
    exit 1
fi
