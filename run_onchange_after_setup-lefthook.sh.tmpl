#!/usr/bin/env bash
# =============================================================================
# Lefthook Setup Script
# =============================================================================
# This script runs automatically when lefthook.yml changes.
# It installs Git hooks managed by lefthook.
#
# Execution: run_onchange_after (runs after dotfiles applied, when lefthook.yml changes)
# Depends on: lefthook, gitleaks (installed via Brewfile)
#
# Hash: {{ include "lefthook.yml" | sha256sum }}

set -euo pipefail

echo "ü™ù Setting up lefthook Git hooks..."

# =============================================================================
# Ensure Homebrew tools are in PATH
# =============================================================================
# This is necessary because this script runs in the same shell session
# where Homebrew was just installed, and PATH may not be updated yet.

{{ if eq .chezmoi.os "darwin" -}}
{{   if eq .chezmoi.arch "arm64" -}}
if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{   else -}}
if [ -x "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{   end -}}
{{ else -}}
if [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{ end -}}

# =============================================================================
# Verify Required Tools
# =============================================================================

# Check if lefthook is installed
if ! command -v lefthook &> /dev/null; then
    echo "‚ùå ERROR: lefthook not found"
    echo ""
    echo "lefthook should have been installed via Brewfile."
    echo "Please ensure run_onchange_install-packages.sh completed successfully."
    echo ""
    echo "To manually install: brew install lefthook"
    exit 1
fi

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo "‚ö†Ô∏è  WARNING: gitleaks not found"
    echo "   Some hooks may not work. Install with: brew install gitleaks"
fi

# Navigate to dotfiles directory
cd "{{ .chezmoi.sourceDir }}"

# Install lefthook hooks
if lefthook install; then
    echo "‚úÖ Lefthook hooks installed successfully"

    # Show installed hooks
    if [ -d .git/hooks ]; then
        echo ""
        echo "üìã Installed hooks:"
        ls -la .git/hooks/ | grep -E "(pre-commit|pre-push)" || echo "   No hooks found"
    fi
else
    echo "‚ùå Failed to install lefthook hooks"
    exit 1
fi

echo ""
echo "üí° Usage:"
echo "   ‚Ä¢ Hooks run automatically on commit/push"
echo "   ‚Ä¢ Skip all: LEFTHOOK=0 git commit"
echo "   ‚Ä¢ Skip specific: LEFTHOOK_EXCLUDE=gitleaks git commit"
echo "   ‚Ä¢ Manual run: lefthook run pre-commit"
echo ""
echo "üìö Documentation: docs/PRE_COMMIT_HOOKS.md"
